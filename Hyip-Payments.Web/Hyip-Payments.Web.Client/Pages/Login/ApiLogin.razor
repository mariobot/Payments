@page "/api-login"
@rendermode InteractiveAuto
@using Hyip_Payments.Web.Client.Services
@using System.Net.Http.Json
@using System.Text.Json
@inject HttpClient Http
@inject IAuthTokenService TokenService
@inject NavigationManager Navigation

<PageTitle>API Login</PageTitle>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0"><i class="bi bi-key"></i> API Login</h3>
                </div>
                <div class="card-body">
                    <EditForm Model="@loginModel" OnValidSubmit="HandleLogin">
                        <DataAnnotationsValidator />
                        
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <InputText @bind-Value="loginModel.Email" class="form-control" placeholder="Enter email" />
                            <ValidationMessage For="@(() => loginModel.Email)" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <InputText type="password" @bind-Value="loginModel.Password" class="form-control" placeholder="Enter password" />
                            <ValidationMessage For="@(() => loginModel.Password)" />
                        </div>

                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle"></i> @errorMessage
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(successMessage))
                        {
                            <div class="alert alert-success">
                                <i class="bi bi-check-circle"></i> @successMessage
                            </div>
                        }

                        <button type="submit" class="btn btn-primary w-100" disabled="@isLoading">
                            @if (isLoading)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            <i class="bi bi-box-arrow-in-right"></i> Login
                        </button>
                    </EditForm>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(currentToken))
            {
                <div class="card mt-3">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-shield-check"></i> Token Stored</h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-2"><strong>Token Preview:</strong></p>
                        <code class="d-block bg-light p-2 small text-break">
                            @(currentToken.Length > 100 ? currentToken.Substring(0, 100) + "..." : currentToken)
                        </code>
                        <div class="mt-3">
                            <button class="btn btn-sm btn-info" @onclick="TestAuthenticatedRequest">
                                <i class="bi bi-play-circle"></i> Test Authenticated Request
                            </button>
                            <button class="btn btn-sm btn-danger" @onclick="Logout">
                                <i class="bi bi-box-arrow-right"></i> Logout
                            </button>
                        </div>
                    </div>
                </div>
            }

            @if (!string.IsNullOrEmpty(testResult))
            {
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-clipboard-data"></i> Test Result</h5>
                    </div>
                    <div class="card-body">
                        <pre class="bg-light p-3">@testResult</pre>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private LoginModel loginModel = new();
    private string? errorMessage;
    private string? successMessage;
    private string? currentToken;
    private string? testResult;
    private bool isLoading;

    protected override async Task OnInitializedAsync()
    {
        // Check if already logged in
        currentToken = await TokenService.GetTokenAsync();
    }

    private async Task HandleLogin()
    {
        isLoading = true;
        errorMessage = null;
        successMessage = null;

        try
        {
            var response = await Http.PostAsJsonAsync("api/Auth/login", new
            {
                email = loginModel.Email,
                password = loginModel.Password
            });

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<LoginResponse>();
                
                if (result != null && !string.IsNullOrEmpty(result.Token))
                {
                    // Store token in localStorage
                    await TokenService.SetTokenAsync(result.Token);
                    currentToken = result.Token;
                    
                    successMessage = $"Login successful! Welcome, {result.User?.Username}";
                    
                    // Redirect after short delay
                    await Task.Delay(1500);
                    Navigation.NavigateTo("/");
                }
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                errorMessage = $"Login failed: {response.StatusCode} - {error}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task TestAuthenticatedRequest()
    {
        testResult = "Loading...";
        
        try
        {
            // This request will automatically include the Bearer token
            var response = await Http.GetAsync("api/Product");
            
            if (response.IsSuccessStatusCode)
            {
                var products = await response.Content.ReadAsStringAsync();
                testResult = $"✅ Authenticated request successful!\n\nResponse:\n{products.Substring(0, Math.Min(500, products.Length))}...";
            }
            else
            {
                testResult = $"❌ Request failed: {response.StatusCode}\n{await response.Content.ReadAsStringAsync()}";
            }
        }
        catch (Exception ex)
        {
            testResult = $"❌ Error: {ex.Message}";
        }
    }

    private async Task Logout()
    {
        // Call API logout to clear cookie
        try
        {
            await Http.PostAsync("api/Auth/logout", null);
        }
        catch
        {
            // Ignore logout errors
        }

        // Clear JWT token from localStorage
        await TokenService.RemoveTokenAsync();

        currentToken = null;
        successMessage = "Logged out successfully. Please refresh the page.";
        testResult = null;
    }

    public class LoginModel
    {
        public string Email { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
    }

    public class LoginResponse
    {
        public string Token { get; set; } = string.Empty;
        public UserInfo? User { get; set; }
    }

    public class UserInfo
    {
        public int Id { get; set; }
        public string Username { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public List<string> Roles { get; set; } = new();
    }
}
