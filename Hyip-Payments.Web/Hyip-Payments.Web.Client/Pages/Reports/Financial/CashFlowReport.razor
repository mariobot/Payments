@page "/reports/cash-flow"
@using Hyip_Payments.Models.Reports
@inject HttpClient Http

<PageTitle>Cash Flow Report - HYIP Payments</PageTitle>

<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="bi bi-cash-coin"></i> Cash Flow Report</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/reports">Reports</a></li>
                    <li class="breadcrumb-item active">Cash Flow</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Date Range Filter -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-funnel"></i> Filter Options</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label fw-bold">Start Date</label>
                    <input type="date" class="form-control" @bind="startDate" />
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold">End Date</label>
                    <input type="date" class="form-control" @bind="endDate" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">&nbsp;</label>
                    <button class="btn btn-primary w-100" @onclick="LoadReport" disabled="@isLoading">
                        @if (isLoading)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        <i class="bi bi-search"></i> Generate Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center my-5">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Calculating cash flow...</p>
        </div>
    }
    else if (reportData != null)
    {
        <!-- Cash Flow Health Banner -->
        <div class="alert @GetHealthAlertClass(reportData.Summary.CashFlowHealth) alert-dismissible fade show" role="alert">
            <h5 class="alert-heading">
                <i class="bi @GetHealthIcon(reportData.Summary.CashFlowHealth)"></i> 
                Cash Flow Health: @reportData.Summary.CashFlowHealth
            </h5>
            <hr>
            <p class="mb-0">
                @if (reportData.NetCashFlow >= 0)
                {
                    <text>
                        <strong>‚úÖ Positive Cash Flow:</strong> Net increase of $@reportData.NetCashFlow.ToString("N2") 
                        during this period (@reportData.Summary.CashFlowGrowthRate.ToString("N1")% growth).
                    </text>
                }
                else
                {
                    <text>
                        <strong>‚ö†Ô∏è Negative Cash Flow:</strong> Net decrease of $@Math.Abs(reportData.NetCashFlow).ToString("N2"). 
                        Review outflows and collection processes.
                    </text>
                }
            </p>
        </div>

        <!-- Cash Position Cards -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card border-info shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted mb-2">Opening Balance</h6>
                        <h2 class="text-info mb-0">$@reportData.OpeningBalance.ToString("N2")</h2>
                        <small class="text-muted">Start of period</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card border-success shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted mb-2">Total Inflows</h6>
                        <h2 class="text-success mb-0">$@reportData.Summary.TotalInflows.ToString("N2")</h2>
                        <small class="text-muted">Cash received</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card border-danger shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted mb-2">Total Outflows</h6>
                        <h2 class="text-danger mb-0">$@reportData.Summary.TotalOutflows.ToString("N2")</h2>
                        <small class="text-muted">Cash paid</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card @(reportData.NetCashFlow >= 0 ? "border-success" : "border-danger") shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted mb-2">Closing Balance</h6>
                        <h2 class="@(reportData.NetCashFlow >= 0 ? "text-success" : "text-danger") mb-0">
                            $@reportData.ClosingBalance.ToString("N2")
                        </h2>
                        <small class="text-muted">End of period</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Net Cash Flow Card -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card @(reportData.NetCashFlow >= 0 ? "border-success" : "border-danger") shadow-sm">
                    <div class="card-body text-center">
                        <i class="bi @(reportData.NetCashFlow >= 0 ? "bi-arrow-up-circle" : "bi-arrow-down-circle") @(reportData.NetCashFlow >= 0 ? "text-success" : "text-danger")" style="font-size: 2.5rem;"></i>
                        <h5 class="mt-2 mb-1">Net Cash Flow</h5>
                        <h2 class="@(reportData.NetCashFlow >= 0 ? "text-success" : "text-danger") mb-1">
                            @(reportData.NetCashFlow >= 0 ? "+" : "")$@reportData.NetCashFlow.ToString("N2")
                        </h2>
                        <p class="mb-0">
                            <strong>Growth Rate:</strong> @reportData.Summary.CashFlowGrowthRate.ToString("N1")%
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cash Flow by Activity -->
        <div class="row mb-4">
            <div class="col-md-4 mb-3">
                <div class="card border-primary shadow-sm">
                    <div class="card-body">
                        <h6 class="mb-3"><i class="bi bi-briefcase"></i> Operating Activities</h6>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Inflows:</span>
                            <span class="text-success">$@reportData.Summary.OperatingInflows.ToString("N2")</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Outflows:</span>
                            <span class="text-danger">$@reportData.Summary.OperatingOutflows.ToString("N2")</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between">
                            <strong>Net Cash Flow:</strong>
                            <strong class="@(reportData.Summary.OperatingNetCashFlow >= 0 ? "text-success" : "text-danger")">
                                $@reportData.Summary.OperatingNetCashFlow.ToString("N2")
                            </strong>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card border-info shadow-sm">
                    <div class="card-body">
                        <h6 class="mb-3"><i class="bi bi-graph-up-arrow"></i> Investing Activities</h6>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Inflows:</span>
                            <span class="text-success">$@reportData.Summary.InvestingInflows.ToString("N2")</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Outflows:</span>
                            <span class="text-danger">$@reportData.Summary.InvestingOutflows.ToString("N2")</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between">
                            <strong>Net Cash Flow:</strong>
                            <strong class="@(reportData.Summary.InvestingNetCashFlow >= 0 ? "text-success" : "text-danger")">
                                $@reportData.Summary.InvestingNetCashFlow.ToString("N2")
                            </strong>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card border-warning shadow-sm">
                    <div class="card-body">
                        <h6 class="mb-3"><i class="bi bi-bank"></i> Financing Activities</h6>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Inflows:</span>
                            <span class="text-success">$@reportData.Summary.FinancingInflows.ToString("N2")</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Outflows:</span>
                            <span class="text-danger">$@reportData.Summary.FinancingOutflows.ToString("N2")</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between">
                            <strong>Net Cash Flow:</strong>
                            <strong class="@(reportData.Summary.FinancingNetCashFlow >= 0 ? "text-success" : "text-danger")">
                                $@reportData.Summary.FinancingNetCashFlow.ToString("N2")
                            </strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Daily Averages -->
        <div class="row mb-4">
            <div class="col-md-4 mb-3">
                <div class="card border-success shadow-sm">
                    <div class="card-body text-center">
                        <i class="bi bi-arrow-down-circle text-success" style="font-size: 2rem;"></i>
                        <h6 class="text-muted mb-1 mt-2">Avg Daily Inflow</h6>
                        <h4 class="mb-1">$@reportData.Summary.AverageDailyInflow.ToString("N2")</h4>
                        <small class="text-muted">Per day</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card border-danger shadow-sm">
                    <div class="card-body text-center">
                        <i class="bi bi-arrow-up-circle text-danger" style="font-size: 2rem;"></i>
                        <h6 class="text-muted mb-1 mt-2">Avg Daily Outflow</h6>
                        <h4 class="mb-1">$@reportData.Summary.AverageDailyOutflow.ToString("N2")</h4>
                        <small class="text-muted">Per day</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card @(reportData.Summary.AverageDailyNetFlow >= 0 ? "border-success" : "border-danger") shadow-sm">
                    <div class="card-body text-center">
                        <i class="bi bi-graph-up @(reportData.Summary.AverageDailyNetFlow >= 0 ? "text-success" : "text-danger")" style="font-size: 2rem;"></i>
                        <h6 class="text-muted mb-1 mt-2">Avg Daily Net Flow</h6>
                        <h4 class="mb-1 @(reportData.Summary.AverageDailyNetFlow >= 0 ? "text-success" : "text-danger")">
                            $@reportData.Summary.AverageDailyNetFlow.ToString("N2")
                        </h4>
                        <small class="text-muted">Per day</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cash Flow Statement -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-file-text"></i> Cash Flow Statement</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tbody>
                        <tr class="table-info">
                            <td><strong>CASH FLOWS FROM OPERATING ACTIVITIES</strong></td>
                            <td class="text-end"></td>
                        </tr>
                        <tr>
                            <td class="ps-4">Cash Inflows from Operations</td>
                            <td class="text-end text-success">$@reportData.Summary.OperatingInflows.ToString("N2")</td>
                        </tr>
                        <tr>
                            <td class="ps-4">Cash Outflows from Operations</td>
                            <td class="text-end text-danger">($@reportData.Summary.OperatingOutflows.ToString("N2"))</td>
                        </tr>
                        <tr class="table-light">
                            <td class="ps-4"><strong>Net Cash from Operating Activities</strong></td>
                            <td class="text-end"><strong class="@(reportData.Summary.OperatingNetCashFlow >= 0 ? "text-success" : "text-danger")">$@reportData.Summary.OperatingNetCashFlow.ToString("N2")</strong></td>
                        </tr>

                        <tr><td colspan="2">&nbsp;</td></tr>

                        <tr class="table-info">
                            <td><strong>CASH FLOWS FROM INVESTING ACTIVITIES</strong></td>
                            <td class="text-end"></td>
                        </tr>
                        <tr>
                            <td class="ps-4">Cash Inflows from Investments</td>
                            <td class="text-end text-success">$@reportData.Summary.InvestingInflows.ToString("N2")</td>
                        </tr>
                        <tr>
                            <td class="ps-4">Cash Outflows from Investments</td>
                            <td class="text-end text-danger">($@reportData.Summary.InvestingOutflows.ToString("N2"))</td>
                        </tr>
                        <tr class="table-light">
                            <td class="ps-4"><strong>Net Cash from Investing Activities</strong></td>
                            <td class="text-end"><strong class="@(reportData.Summary.InvestingNetCashFlow >= 0 ? "text-success" : "text-danger")">$@reportData.Summary.InvestingNetCashFlow.ToString("N2")</strong></td>
                        </tr>

                        <tr><td colspan="2">&nbsp;</td></tr>

                        <tr class="table-info">
                            <td><strong>CASH FLOWS FROM FINANCING ACTIVITIES</strong></td>
                            <td class="text-end"></td>
                        </tr>
                        <tr>
                            <td class="ps-4">Cash Inflows from Financing</td>
                            <td class="text-end text-success">$@reportData.Summary.FinancingInflows.ToString("N2")</td>
                        </tr>
                        <tr>
                            <td class="ps-4">Cash Outflows from Financing</td>
                            <td class="text-end text-danger">($@reportData.Summary.FinancingOutflows.ToString("N2"))</td>
                        </tr>
                        <tr class="table-light">
                            <td class="ps-4"><strong>Net Cash from Financing Activities</strong></td>
                            <td class="text-end"><strong class="@(reportData.Summary.FinancingNetCashFlow >= 0 ? "text-success" : "text-danger")">$@reportData.Summary.FinancingNetCashFlow.ToString("N2")</strong></td>
                        </tr>

                        <tr><td colspan="2">&nbsp;</td></tr>

                        <tr class="table-primary">
                            <td><strong>NET INCREASE/(DECREASE) IN CASH</strong></td>
                            <td class="text-end">
                                <strong class="@(reportData.NetCashFlow >= 0 ? "text-success" : "text-danger")">
                                    $@reportData.NetCashFlow.ToString("N2")
                                </strong>
                            </td>
                        </tr>
                        <tr>
                            <td>Cash at Beginning of Period</td>
                            <td class="text-end">$@reportData.OpeningBalance.ToString("N2")</td>
                        </tr>
                        <tr class="table-success">
                            <td><strong>CASH AT END OF PERIOD</strong></td>
                            <td class="text-end"><strong>$@reportData.ClosingBalance.ToString("N2")</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Daily Cash Flow Trend -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-graph-up"></i> Daily Cash Flow Trend</h5>
            </div>
            <div class="card-body">
                @if (reportData.DailyCashFlow.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th class="text-end">Inflows</th>
                                    <th class="text-end">Outflows</th>
                                    <th class="text-end">Net Flow</th>
                                    <th class="text-end">Running Balance</th>
                                    <th class="text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var day in reportData.DailyCashFlow)
                                {
                                    var isPositive = day.NetFlow >= 0;
                                    <tr class="@(isPositive ? "table-success" : "table-warning")">
                                        <td>@day.Date.ToString("MMM dd, yyyy")</td>
                                        <td class="text-end text-success">$@day.Inflows.ToString("N2")</td>
                                        <td class="text-end text-danger">$@day.Outflows.ToString("N2")</td>
                                        <td class="text-end @(isPositive ? "text-success" : "text-danger") fw-bold">
                                            @(isPositive ? "+" : "")$@day.NetFlow.ToString("N2")
                                        </td>
                                        <td class="text-end fw-bold">$@day.RunningBalance.ToString("N2")</td>
                                        <td class="text-center">
                                            @if (isPositive)
                                            {
                                                <span class="badge bg-success">Positive</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-warning text-dark">Negative</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <!-- Daily Summary -->
                    <div class="alert alert-info mt-3">
                        <i class="bi bi-calendar-check"></i> 
                        <strong>Daily Performance:</strong> 
                        @reportData.Summary.PositiveDays positive days, 
                        @reportData.Summary.NegativeDays negative days
                    </div>
                }
                else
                {
                    <div class="alert alert-info mb-0">
                        <i class="bi bi-info-circle"></i> No daily cash flow data available.
                    </div>
                }
            </div>
        </div>

        <!-- Cash Flow Insights -->
        <div class="card mb-4">
            <div class="card-header @GetHealthHeaderClass(reportData.Summary.CashFlowHealth)">
                <h5 class="mb-0"><i class="bi bi-lightbulb"></i> Cash Flow Insights</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Performance Metrics</h6>
                        <ul>
                            <li><strong>Cash Flow Health:</strong> <span class="@GetHealthTextClass(reportData.Summary.CashFlowHealth)">@reportData.Summary.CashFlowHealth</span></li>
                            <li><strong>Growth Rate:</strong> @reportData.Summary.CashFlowGrowthRate.ToString("N1")%</li>
                            <li><strong>Highest Daily Inflow:</strong> $@reportData.Summary.HighestDailyInflow.ToString("N2")</li>
                            <li><strong>Highest Daily Outflow:</strong> $@reportData.Summary.HighestDailyOutflow.ToString("N2")</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Recommendations</h6>
                        <ul>
                            @if (reportData.NetCashFlow < 0)
                            {
                                <li class="text-danger">
                                    <strong>üö® Negative Cash Flow:</strong> Implement collection strategies and reduce discretionary spending.
                                </li>
                            }
                            @if (reportData.Summary.AverageDailyOutflow > reportData.Summary.AverageDailyInflow)
                            {
                                <li class="text-warning">
                                    <strong>‚ö†Ô∏è Outflows Exceed Inflows:</strong> Average daily outflow is higher than inflow. Monitor closely.
                                </li>
                            }
                            @if (reportData.Summary.OperatingNetCashFlow < 0)
                            {
                                <li class="text-danger">
                                    <strong>üíº Negative Operating Cash Flow:</strong> Core operations not generating positive cash. Review business model.
                                </li>
                            }
                            @if (reportData.NetCashFlow > 0 && reportData.Summary.OperatingNetCashFlow > 0)
                            {
                                <li class="text-success">
                                    <strong>‚úÖ Healthy Cash Flow:</strong> Both overall and operating cash flows are positive!
                                </li>
                            }
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Buttons -->
        <div class="card">
            <div class="card-body">
                <h5 class="mb-3"><i class="bi bi-download"></i> Export Report</h5>
                <button class="btn btn-danger me-2" disabled>
                    <i class="bi bi-file-pdf"></i> Export to PDF
                </button>
                <button class="btn btn-success me-2" disabled>
                    <i class="bi bi-file-excel"></i> Export to Excel
                </button>
                <button class="btn btn-info" disabled>
                    <i class="bi bi-file-earmark-spreadsheet"></i> Export to CSV
                </button>
                <p class="text-muted mt-2 mb-0"><small><i class="bi bi-info-circle"></i> Export functionality coming soon</small></p>
            </div>
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i> @errorMessage
        </div>
        <button class="btn btn-primary" @onclick="LoadReport">
            <i class="bi bi-arrow-clockwise"></i> Retry
        </button>
    }
</div>

@code {
    private DateTime startDate = DateTime.Now.AddMonths(-1).Date;
    private DateTime endDate = DateTime.Now.Date;
    private bool isLoading = false;
    private CashFlowReportModel? reportData;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadReport();
    }

    private async Task LoadReport()
    {
        isLoading = true;
        errorMessage = null;
        reportData = null;

        try
        {
            var url = $"api/FinancialReport/cash-flow?startDate={startDate:yyyy-MM-dd}&endDate={endDate:yyyy-MM-dd}";
            reportData = await Http.GetFromJsonAsync<CashFlowReportModel>(url);
        }
        catch (HttpRequestException httpEx)
        {
            errorMessage = $"Network error: {httpEx.Message}. Please check if the API is running.";
            Console.WriteLine($"HTTP Error: {httpEx.Message}");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading cash flow report: {ex.Message}";
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetHealthAlertClass(string health)
    {
        return health switch
        {
            "Positive" => "alert-success",
            "Stable" => "alert-info",
            "Negative" => "alert-danger",
            _ => "alert-secondary"
        };
    }

    private string GetHealthIcon(string health)
    {
        return health switch
        {
            "Positive" => "bi-check-circle-fill",
            "Stable" => "bi-dash-circle",
            "Negative" => "bi-exclamation-triangle-fill",
            _ => "bi-question-circle"
        };
    }

    private string GetHealthHeaderClass(string health)
    {
        return health switch
        {
            "Positive" => "bg-success text-white",
            "Stable" => "bg-info text-white",
            "Negative" => "bg-danger text-white",
            _ => "bg-light"
        };
    }

    private string GetHealthTextClass(string health)
    {
        return health switch
        {
            "Positive" => "text-success fw-bold",
            "Stable" => "text-info fw-bold",
            "Negative" => "text-danger fw-bold",
            _ => "text-muted"
        };
    }
}
