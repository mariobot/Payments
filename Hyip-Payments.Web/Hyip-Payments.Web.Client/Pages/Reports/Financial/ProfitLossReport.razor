@page "/reports/profit-loss"
@using Hyip_Payments.Models.Reports
@inject HttpClient Http

<PageTitle>Profit & Loss Report - HYIP Payments</PageTitle>

<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="bi bi-calculator"></i> Profit & Loss Statement</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/reports">Reports</a></li>
                    <li class="breadcrumb-item active">Profit & Loss</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Date Range Filter -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-funnel"></i> Filter Options</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label fw-bold">Start Date</label>
                    <input type="date" class="form-control" @bind="startDate" />
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold">End Date</label>
                    <input type="date" class="form-control" @bind="endDate" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">&nbsp;</label>
                    <button class="btn btn-primary w-100" @onclick="LoadReport" disabled="@isLoading">
                        @if (isLoading)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        <i class="bi bi-search"></i> Generate Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center my-5">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Calculating profit & loss...</p>
        </div>
    }
    else if (reportData != null)
    {
        <!-- Financial Health Banner -->
        <div class="alert @GetHealthAlertClass(reportData.Summary.FinancialHealth) alert-dismissible fade show" role="alert">
            <h5 class="alert-heading">
                <i class="bi @GetHealthIcon(reportData.Summary.FinancialHealth)"></i> 
                Financial Health: @reportData.Summary.FinancialHealth
            </h5>
            <hr>
            <p class="mb-0">
                @if (reportData.IsProfitable)
                {
                    <text>
                        <strong>‚úÖ Profitable Period:</strong> Net profit of $@reportData.NetProfit.ToString("N2") 
                        with @reportData.ProfitMargin.ToString("N1")% profit margin.
                    </text>
                }
                else
                {
                    <text>
                        <strong>‚ö†Ô∏è Loss Period:</strong> Net loss of $@Math.Abs(reportData.NetProfit).ToString("N2"). 
                        Review expenses and revenue strategies.
                    </text>
                }
            </p>
        </div>

        <!-- Key Metrics Cards -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card border-success shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted mb-2">Total Revenue</h6>
                        <h2 class="text-success mb-0">$@reportData.TotalRevenue.ToString("N2")</h2>
                        <small class="text-muted">@reportData.TotalRevenueTransactions transactions</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card border-danger shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted mb-2">Total Expenses</h6>
                        <h2 class="text-danger mb-0">$@reportData.TotalExpenses.ToString("N2")</h2>
                        <small class="text-muted">@reportData.Summary.ExpenseRatio.ToString("N1")% of revenue</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card @(reportData.IsProfitable ? "border-success" : "border-danger") shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted mb-2">Net Profit/Loss</h6>
                        <h2 class="@(reportData.IsProfitable ? "text-success" : "text-danger") mb-0">
                            @(reportData.IsProfitable ? "" : "-")$@Math.Abs(reportData.NetProfit).ToString("N2")
                        </h2>
                        <small class="text-muted">
                            @(reportData.IsProfitable ? "Profit" : "Loss")
                        </small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card @GetProfitMarginBorder(reportData.ProfitMargin) shadow-sm">
                    <div class="card-body">
                        <h6 class="text-muted mb-2">Profit Margin</h6>
                        <h2 class="@GetProfitMarginColor(reportData.ProfitMargin) mb-0">
                            @reportData.ProfitMargin.ToString("N1")%
                        </h2>
                        <small class="text-muted">Net margin</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="row mb-4">
            <div class="col-md-4 mb-3">
                <div class="card border-primary shadow-sm">
                    <div class="card-body text-center">
                        <i class="bi bi-cash-coin text-primary" style="font-size: 2rem;"></i>
                        <h6 class="text-muted mb-1 mt-2">Avg Revenue/Day</h6>
                        <h4 class="mb-1">$@reportData.Summary.AverageRevenuePerDay.ToString("N2")</h4>
                        <small class="text-muted">Daily average</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card border-warning shadow-sm">
                    <div class="card-body text-center">
                        <i class="bi bi-credit-card text-warning" style="font-size: 2rem;"></i>
                        <h6 class="text-muted mb-1 mt-2">Avg Expense/Day</h6>
                        <h4 class="mb-1">$@reportData.Summary.AverageExpensePerDay.ToString("N2")</h4>
                        <small class="text-muted">Daily average</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card @(reportData.Summary.AverageProfitPerDay >= 0 ? "border-success" : "border-danger") shadow-sm">
                    <div class="card-body text-center">
                        <i class="bi bi-graph-up-arrow @(reportData.Summary.AverageProfitPerDay >= 0 ? "text-success" : "text-danger")" style="font-size: 2rem;"></i>
                        <h6 class="text-muted mb-1 mt-2">Avg Profit/Day</h6>
                        <h4 class="mb-1 @(reportData.Summary.AverageProfitPerDay >= 0 ? "text-success" : "text-danger")">
                            $@reportData.Summary.AverageProfitPerDay.ToString("N2")
                        </h4>
                        <small class="text-muted">Daily average</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Income Statement -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-receipt"></i> Income Statement</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tbody>
                        <tr class="table-light">
                            <td colspan="2"><strong>REVENUE</strong></td>
                        </tr>
                        <tr>
                            <td class="ps-4">Completed Payments (@reportData.Summary.CompletedPaymentsCount)</td>
                            <td class="text-end text-success fw-bold">$@reportData.Summary.CompletedPaymentsRevenue.ToString("N2")</td>
                        </tr>
                        <tr class="table-success">
                            <td><strong>Total Revenue</strong></td>
                            <td class="text-end"><strong>$@reportData.TotalRevenue.ToString("N2")</strong></td>
                        </tr>
                        
                        <tr><td colspan="2">&nbsp;</td></tr>
                        
                        <tr class="table-light">
                            <td colspan="2"><strong>EXPENSES</strong></td>
                        </tr>
                        <tr>
                            <td class="ps-4">Processing Fees (2% of revenue)</td>
                            <td class="text-end text-danger">$@reportData.Summary.ProcessingFeesExpense.ToString("N2")</td>
                        </tr>
                        <tr>
                            <td class="ps-4">Failed Transaction Costs</td>
                            <td class="text-end text-danger">$@reportData.Summary.FailedTransactionCosts.ToString("N2")</td>
                        </tr>
                        @if (reportData.Summary.OtherExpenses > 0)
                        {
                            <tr>
                                <td class="ps-4">Other Expenses</td>
                                <td class="text-end text-danger">$@reportData.Summary.OtherExpenses.ToString("N2")</td>
                            </tr>
                        }
                        <tr class="table-danger">
                            <td><strong>Total Expenses</strong></td>
                            <td class="text-end"><strong>$@reportData.TotalExpenses.ToString("N2")</strong></td>
                        </tr>
                        
                        <tr><td colspan="2">&nbsp;</td></tr>
                        
                        <tr class="@(reportData.IsProfitable ? "table-success" : "table-danger")">
                            <td><strong>NET PROFIT/LOSS</strong></td>
                            <td class="text-end">
                                <strong class="@(reportData.IsProfitable ? "text-success" : "text-danger")">
                                    @(reportData.IsProfitable ? "" : "-")$@Math.Abs(reportData.NetProfit).ToString("N2")
                                </strong>
                            </td>
                        </tr>
                        <tr>
                            <td class="ps-4"><em>Profit Margin</em></td>
                            <td class="text-end">
                                <em class="@GetProfitMarginColor(reportData.ProfitMargin)">
                                    @reportData.ProfitMargin.ToString("N1")%
                                </em>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Daily Profit/Loss Trend -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-graph-up"></i> Daily Profit/Loss Trend</h5>
            </div>
            <div class="card-body">
                @if (reportData.ProfitLossByDate.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th class="text-end">Revenue</th>
                                    <th class="text-end">Expenses</th>
                                    <th class="text-end">Net Profit/Loss</th>
                                    <th class="text-end">Margin</th>
                                    <th class="text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var day in reportData.ProfitLossByDate)
                                {
                                    var isProfitable = day.NetProfit >= 0;
                                    <tr class="@(isProfitable ? "table-success" : "table-warning")">
                                        <td>@day.Date.ToString("MMM dd, yyyy")</td>
                                        <td class="text-end text-success">$@day.Revenue.ToString("N2")</td>
                                        <td class="text-end text-danger">$@day.Expenses.ToString("N2")</td>
                                        <td class="text-end @(isProfitable ? "text-success" : "text-danger") fw-bold">
                                            @(isProfitable ? "" : "-")$@Math.Abs(day.NetProfit).ToString("N2")
                                        </td>
                                        <td class="text-end @GetProfitMarginColor(day.ProfitMargin)">
                                            @day.ProfitMargin.ToString("N1")%
                                        </td>
                                        <td class="text-center">
                                            @if (isProfitable)
                                            {
                                                <span class="badge bg-success">Profit</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-warning text-dark">Loss</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot class="table-secondary">
                                <tr>
                                    <td><strong>Total/Average</strong></td>
                                    <td class="text-end"><strong>$@reportData.TotalRevenue.ToString("N2")</strong></td>
                                    <td class="text-end"><strong>$@reportData.TotalExpenses.ToString("N2")</strong></td>
                                    <td class="text-end @(reportData.IsProfitable ? "text-success" : "text-danger")">
                                        <strong>@(reportData.IsProfitable ? "" : "-")$@Math.Abs(reportData.NetProfit).ToString("N2")</strong>
                                    </td>
                                    <td class="text-end"><strong>@reportData.ProfitMargin.ToString("N1")%</strong></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- Day Performance Summary -->
                    <div class="alert alert-info mt-3">
                        <i class="bi bi-calendar-check"></i> 
                        <strong>Day Performance:</strong> 
                        @reportData.Summary.ProfitableDays profitable days, 
                        @reportData.Summary.UnprofitableDays unprofitable days
                    </div>
                }
                else
                {
                    <div class="alert alert-info mb-0">
                        <i class="bi bi-info-circle"></i> No daily trend data available.
                    </div>
                }
            </div>
        </div>

        <!-- Strategic Insights -->
        <div class="card mb-4">
            <div class="card-header @GetHealthHeaderClass(reportData.Summary.FinancialHealth)">
                <h5 class="mb-0"><i class="bi bi-lightbulb"></i> Strategic Financial Insights</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Performance Analysis</h6>
                        <ul>
                            <li>
                                <strong>Financial Health:</strong> 
                                <span class="@GetHealthTextClass(reportData.Summary.FinancialHealth)">
                                    @reportData.Summary.FinancialHealth
                                </span>
                            </li>
                            <li>
                                <strong>Expense Ratio:</strong> @reportData.Summary.ExpenseRatio.ToString("N1")% of revenue
                            </li>
                            <li>
                                <strong>Period:</strong> @((reportData.EndDate - reportData.StartDate).Days) days
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Recommendations</h6>
                        <ul>
                            @if (reportData.ProfitMargin < 10)
                            {
                                <li class="text-danger">
                                    <strong>‚ö†Ô∏è Low Profit Margin:</strong> Consider cost optimization or revenue enhancement strategies.
                                </li>
                            }
                            @if (reportData.Summary.ExpenseRatio > 30)
                            {
                                <li class="text-warning">
                                    <strong>üí° High Expense Ratio:</strong> Review operational costs and negotiate better processing rates.
                                </li>
                            }
                            @if (reportData.IsProfitable && reportData.ProfitMargin >= 20)
                            {
                                <li class="text-success">
                                    <strong>‚úÖ Strong Performance:</strong> Maintain current strategies and scale operations.
                                </li>
                            }
                            @if (!reportData.IsProfitable)
                            {
                                <li class="text-danger">
                                    <strong>üö® Loss Period:</strong> Urgent review of revenue streams and cost structure required.
                                </li>
                            }
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Buttons -->
        <div class="card">
            <div class="card-body">
                <h5 class="mb-3"><i class="bi bi-download"></i> Export Report</h5>
                <button class="btn btn-danger me-2" disabled>
                    <i class="bi bi-file-pdf"></i> Export to PDF
                </button>
                <button class="btn btn-success me-2" disabled>
                    <i class="bi bi-file-excel"></i> Export to Excel
                </button>
                <button class="btn btn-info" disabled>
                    <i class="bi bi-file-earmark-spreadsheet"></i> Export to CSV
                </button>
                <p class="text-muted mt-2 mb-0"><small><i class="bi bi-info-circle"></i> Export functionality coming soon</small></p>
            </div>
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i> @errorMessage
        </div>
        <button class="btn btn-primary" @onclick="LoadReport">
            <i class="bi bi-arrow-clockwise"></i> Retry
        </button>
    }
</div>

@code {
    private DateTime startDate = DateTime.Now.AddMonths(-1).Date;
    private DateTime endDate = DateTime.Now.Date;
    private bool isLoading = false;
    private ProfitLossReportModel? reportData;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadReport();
    }

    private async Task LoadReport()
    {
        isLoading = true;
        errorMessage = null;
        reportData = null;

        try
        {
            var url = $"api/FinancialReport/profit-loss?startDate={startDate:yyyy-MM-dd}&endDate={endDate:yyyy-MM-dd}";
            reportData = await Http.GetFromJsonAsync<ProfitLossReportModel>(url);
        }
        catch (HttpRequestException httpEx)
        {
            errorMessage = $"Network error: {httpEx.Message}. Please check if the API is running.";
            Console.WriteLine($"HTTP Error: {httpEx.Message}");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading profit & loss report: {ex.Message}";
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetHealthAlertClass(string health)
    {
        return health switch
        {
            "Excellent" => "alert-success",
            "Good" => "alert-info",
            "Fair" => "alert-warning",
            "Poor" => "alert-warning",
            "Loss" => "alert-danger",
            _ => "alert-secondary"
        };
    }

    private string GetHealthIcon(string health)
    {
        return health switch
        {
            "Excellent" => "bi-star-fill",
            "Good" => "bi-hand-thumbs-up-fill",
            "Fair" => "bi-dash-circle",
            "Poor" => "bi-exclamation-triangle",
            "Loss" => "bi-x-circle-fill",
            _ => "bi-question-circle"
        };
    }

    private string GetHealthHeaderClass(string health)
    {
        return health switch
        {
            "Excellent" => "bg-success text-white",
            "Good" => "bg-info text-white",
            "Fair" => "bg-warning text-dark",
            "Poor" => "bg-warning text-dark",
            "Loss" => "bg-danger text-white",
            _ => "bg-light"
        };
    }

    private string GetHealthTextClass(string health)
    {
        return health switch
        {
            "Excellent" => "text-success fw-bold",
            "Good" => "text-info fw-bold",
            "Fair" => "text-warning fw-bold",
            "Poor" => "text-warning fw-bold",
            "Loss" => "text-danger fw-bold",
            _ => "text-muted"
        };
    }

    private string GetProfitMarginColor(decimal margin)
    {
        return margin switch
        {
            >= 30 => "text-success",
            >= 15 => "text-info",
            >= 5 => "text-warning",
            >= 0 => "text-secondary",
            _ => "text-danger"
        };
    }

    private string GetProfitMarginBorder(decimal margin)
    {
        return margin switch
        {
            >= 30 => "border-success",
            >= 15 => "border-info",
            >= 5 => "border-warning",
            >= 0 => "border-secondary",
            _ => "border-danger"
        };
    }
}
