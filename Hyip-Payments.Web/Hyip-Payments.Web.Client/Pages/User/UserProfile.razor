@page "/profile"
@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims
@* @attribute [Authorize] *@
@inject HttpClient Http
@inject NavigationManager NavigationManager

<PageTitle>User Profile</PageTitle>

<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h3><i class="bi bi-person-circle"></i> My Profile</h3>
                    <button class="btn btn-sm btn-light" @onclick="EditProfile" disabled="@isLoadingProfile">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                </div>
                <div class="card-body">
                    <AuthorizeView>
                        <Authorized>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Username</label>
                                    <p class="form-control-plaintext">@context.User.Identity?.Name</p>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Authentication Status</label>
                                    <p class="form-control-plaintext">
                                        <span class="badge bg-success">Authenticated</span>
                                    </p>
                                </div>
                            </div>

                            @if (!string.IsNullOrEmpty(email))
                            {
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Email</label>
                                    <p class="form-control-plaintext">@email</p>
                                </div>
                            }

                            @if (!string.IsNullOrEmpty(userId))
                            {
                                <div class="mb-3">
                                    <label class="form-label fw-bold">User ID</label>
                                    <p class="form-control-plaintext">@userId</p>
                                </div>
                            }

                            @if (roles != null && roles.Any())
                            {
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Roles</label>
                                    <p class="form-control-plaintext">
                                        @foreach (var role in roles)
                                        {
                                            <span class="badge bg-info me-1">@role</span>
                                        }
                                    </p>
                                </div>
                            }

                            @if (claims != null && claims.Any())
                            {
                                <div class="mb-3">
                                    <button class="btn btn-sm btn-outline-secondary" @onclick="ToggleClaims">
                                        @(showClaims ? "Hide" : "Show") All Claims
                                    </button>
                                </div>

                                @if (showClaims)
                                {
                                    <div class="card">
                                        <div class="card-body">
                                            <h6>User Claims:</h6>
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>Type</th>
                                                        <th>Value</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var claim in claims)
                                                    {
                                                        <tr>
                                                            <td><small>@claim.Type</small></td>
                                                            <td><small>@claim.Value</small></td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                }
                            }

                            <hr />

                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button class="btn btn-primary" @onclick="GoToUserList">
                                    <i class="bi bi-people"></i> View All Users
                                </button>
                                <button class="btn btn-warning" @onclick="EditProfile" disabled="@isLoadingProfile">
                                    @if (isLoadingProfile)
                                    {
                                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                        <span> Loading...</span>
                                    }
                                    else
                                    {
                                        <i class="bi bi-pencil"></i>
                                        <span> Edit Profile</span>
                                    }
                                </button>
                            </div>

                            @if (string.IsNullOrEmpty(userId))
                            {
                                <div class="alert alert-warning mt-3">
                                    <i class="bi bi-exclamation-triangle"></i> <small>Note: User ID not found in authentication claims. The Edit Profile button will attempt to retrieve it from the API.</small>
                                </div>
                            }

                        </Authorized>
                        <NotAuthorized>
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i> You need to log in to view this page.
                            </div>
                            <a href="/Account/Login" class="btn btn-primary">Login</a>
                        </NotAuthorized>
                    </AuthorizeView>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private List<string> roles = new();
    private List<Claim> claims = new();
    private string? email;
    private string? userId;
    private bool showClaims = false;
    private bool isLoadingProfile = false;

    [CascadingParameter]
    private Task<AuthenticationState>? AuthenticationStateTask { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (AuthenticationStateTask != null)
        {
            var authState = await AuthenticationStateTask;
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                // Get user information from claims
                email = user.FindFirst(ClaimTypes.Email)?.Value 
                     ?? user.FindFirst("email")?.Value;

                userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value 
                      ?? user.FindFirst("sub")?.Value 
                      ?? user.FindFirst("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier")?.Value;

                // Get roles
                roles = user.FindAll(ClaimTypes.Role)
                           .Select(c => c.Value)
                           .ToList();

                if (!roles.Any())
                {
                    roles = user.FindAll("role")
                               .Select(c => c.Value)
                               .ToList();
                }

                // Get all claims for debugging
                claims = user.Claims.ToList();

                // If userId is still not found in claims, try to fetch from API by username or email
                if (string.IsNullOrEmpty(userId) && !string.IsNullOrEmpty(user.Identity.Name))
                {
                    await TryGetUserIdFromApi(user.Identity.Name);
                }
            }
        }
    }

    private async Task TryGetUserIdFromApi(string username)
    {
        try
        {
            isLoadingProfile = true;
            var userFromApi = await Http.GetFromJsonAsync<UserModel>($"api/User/username/{username}");
            if (userFromApi != null)
            {
                userId = userFromApi.Id.ToString();
            }
        }
        catch
        {
            // Fallback: if username lookup fails, try email
            if (!string.IsNullOrEmpty(email))
            {
                try
                {
                    var userFromApi = await Http.GetFromJsonAsync<UserModel>($"api/User/email/{email}");
                    if (userFromApi != null)
                    {
                        userId = userFromApi.Id.ToString();
                    }
                }
                catch
                {
                    // Could not retrieve user ID
                }
            }
        }
        finally
        {
            isLoadingProfile = false;
        }
    }

    private void ToggleClaims()
    {
        showClaims = !showClaims;
    }

    private void GoToUserList()
    {
        NavigationManager.NavigateTo("/user/list");
    }

    private async Task EditProfile()
    {
        // If userId is not available, show alert
        if (string.IsNullOrEmpty(userId))
        {
            // Try one more time to get the user ID
            if (AuthenticationStateTask != null)
            {
                var authState = await AuthenticationStateTask;
                var user = authState.User;
                if (user.Identity?.IsAuthenticated == true && !string.IsNullOrEmpty(user.Identity.Name))
                {
                    await TryGetUserIdFromApi(user.Identity.Name);
                }
            }
        }

        // Navigate to edit profile page if we have userId
        if (!string.IsNullOrEmpty(userId))
        {
            NavigationManager.NavigateTo($"/user/edit/{userId}");
        }
        else
        {
            // Could not determine user ID - navigate to user list as fallback
            NavigationManager.NavigateTo("/user/list");
        }
    }

    // Model for API response
    public class UserModel
    {
        public int Id { get; set; }
        public string Username { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string? FirstName { get; set; }
        public string? LastName { get; set; }
        public bool IsActive { get; set; }
    }
}
